#!/bin/bash

clear

set -e

IP=$(curl https://ifconfig.me/ip)

function update_nginx_config() {
    local param1=$1
    local domain=$2
    local cert=$3
    local key=$4
   
    ssl_cert="/etc/letsencrypt/live/$domain/fullchain.pem"
    ssl_cert_key="/etc/letsencrypt/live/$domain/privkey.pem"

    ssl_cert_self="/etc/nginx/selfsigned_cert.pem"
    ssl_cert_key_self="/etc/nginx/selfsigned_key.pem"


    if [ "$param1" == "self" ]; then
        # —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª /etc/nginx/neutrino_selfsigned.conf –≤ /etc/nginx/sites-enabled/default
        cp /etc/nginx/neutrino_selfsigned.conf  /etc/nginx/sites-enabled/default

        sed -i "s#cert_stub#$ssl_cert_self#g" /usr/share/neutrino-server/back/src/main.ts
        sed -i "s#key_stub#$ssl_cert_key_self#g" /usr/share/neutrino-server/back/src/main.ts

    elif [ "$param1" == "ca" ]; then
        # —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª /etc/nginx/neutrino_casigned.conf –≤ //etc/nginx/sites-enabled/default
        cp /etc/nginx/neutrino_casigned.conf  /etc/nginx/sites-enabled/default
        
        # –∑–∞–º–µ–Ω–∏—Ç—å –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ "your_domain" –≤ —Ñ–∞–π–ª–µ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π $domain
        sed -i "s#your_domain#$domain#g" /etc/nginx/sites-enabled/default

        sed -i "s#cert_stub#$ssl_cert#g" /usr/share/neutrino-server/back/src/main.ts
        sed -i "s#key_stub#$ssl_cert_key#g" /usr/share/neutrino-server/back/src/main.ts

    elif [ "$param1" == "custom" ] && [ "$domain" ] && [ "$cert" ] && [ "$key" ]; then
        # —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª /etc/nginx/neutrino_own.conf –≤ /etc/nginx/sites-enabled/default
        cp /etc/nginx/neutrino_custom.conf  /etc/nginx/sites-enabled/default
        
        # –∑–∞–º–µ–Ω–∏—Ç—å –ø–æ–¥—Å—Ç—Ä–æ–∫–∏
        sed -i "s#domain_stub#$domain#g" /etc/nginx/sites-enabled/default
        sed -i "s#cert_stub#$cert#g" /etc/nginx/sites-enabled/default
        sed -i "s#key_stub#$key#g" /etc/nginx/sites-enabled/default
        sed -i "s#cert_stub#$cert#g" /usr/share/neutrino-server/back/src/main.ts
        sed -i "s#key_stub#$key#g" /usr/share/neutrino-server/back/src/main.ts

    else
        echo "–ù–µ –ø–µ—Ä–µ–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π —Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏  'self' | 'ca' | 'custom'. "
    fi
}

function create_selfsigned_cert() {
    echo ""
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/selfsigned_key.pem -out /etc/nginx/selfsigned_cert.pem
    echo ""
}

function create_casigned_cert() {
    echo "–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è –¥–æ–º–µ–Ω–∞ $domain"
    read email
    
    certbot certonly --standalone --agree-tos --email "$email" --domains "$domain" --non-interactive
 
    return $?
}

# ---------------------------------------------------------------------------- #

echo ""
echo "Post-install script processing"


cd "/usr/share/neutrino-server/back"

sudo n lts
echo üî•
sudo node -v

sudo npm i  
echo "‚úÖ Install node modules for backend"

cd "/usr/share/neutrino-server/front"
echo 'VUE_APP_BACKEND_HOST='$IP > .env 

sudo n lts
echo üî•
sudo node -v

sudo npm i
echo "‚úÖ Install node modules for frontend"
sudo npm run build 


# ---------------------------------------------------------------------------- #

echo ""
echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
echo "–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏: "
read domain

echo ""
echo "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏: "
read cert
echo ""

if [ "$cert" ]; then
    echo "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –∫–ª—é—á—É –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏: "
    read key
    echo ""
fi

if [ "$domain" ] && [ "$cert" ] && [ "$key" ]; then
    # –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –¥–æ–º–µ–Ω, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á
    update_nginx_config "custom" "$domain" "$cert" "$key" 

elif [ "$key" ] && [ "$cert" ]; then
    # –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á, –Ω–æ –Ω–µ—Ç –¥–æ–º–µ–Ω–∞
    update_nginx_config "custom" "_" "$cert" "$key" 

elif [ "$domain" ]; then
    # –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ–º–µ–Ω
    echo "–°–æ–∑–¥–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –ø–æ–º–æ—â—å—é Lets Encrypt"
    echo ""
    create_casigned_cert
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–∑–¥–∞–Ω"
        echo ""
        
        update_nginx_config "ca" "$domain"

        echo ""
        echo "–°–æ–∑–¥–∞–Ω–∏–µ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ –∑–∞–ø–∏—Å–∏ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞."
        sudo cp /etc/nginx/_certbot /etc/cron.d/certbot
    else
        echo ""
        echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç EFF."
        echo ""
        echo "–°–æ–∑–¥–∞—Ç—å —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç? (Y/n)"
        read generate_selfsigned_answer
        echo ""
        
        if [ -n '$generate_selfsigned_answer' ] || [ '$generate_selfsigned_answer' == 'y' ] || [] '$generate_selfsigned_answer' -eq 'Y' ]; then
            create_selfsigned_cert
            update_nginx_config "self"
        else
            exit $?
        fi
    fi
   
else
    # –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
    echo "–°–æ–∑–¥–∞–µ–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
    echo ""
    create_selfsigned_cert
    update_nginx_config "self"
fi

echo ""
echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

echo "–ó–∞–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ neutrino panel"

password=""

while [[ -z "$password" ]]; do
    read -s password

    if [[ -z "$password" ]]; then
        echo "–ü–∞—Ä–æ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Å–Ω–æ–≤–∞."
    fi
done

HASH=$(echo -n $password | md5sum | awk '{print $1}')


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–∞–±–ª–∏—Ü
echo
sudo service postgresql start
echo
sudo -u postgres psql -c "CREATE DATABASE neutrino_db;"
sudo -u postgres psql -c "CREATE USER neutrino WITH PASSWORD 'neutrino';"
sudo -u postgres psql -d neutrino_db -c "
  CREATE TABLE IF NOT EXISTS user_password (
    id SERIAL PRIMARY KEY,
    user_name VARCHAR,
    password VARCHAR
  );
  CREATE TABLE IF NOT EXISTS user_credentials (
    id SERIAL PRIMARY KEY,
    username VARCHAR,
    api_key TEXT
  );
"
sudo -u postgres psql -d neutrino_db -c "
     INSERT INTO user_password (user_name, password) 
     VALUES ('admin', '$HASH');
"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON TABLE user_credentials TO neutrino;" -d neutrino_db
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON TABLE user_password TO neutrino;" -d neutrino_db
sudo -u postgres psql -c "GRANT USAGE, SELECT ON SEQUENCE user_credentials_id_seq TO neutrino;" -d neutrino_db


echo

echo "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å, –∏—Å–ø–æ–ª—å–∑—É—è —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ –ø–∞—Ä–æ–ª—å."
echo "–°–ª—É–∂–±–∞ neutrino –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π" 
echo "sudo systemctl start neutrino"
echo "Neutrino –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
echo "–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –≤—ã c–º–æ–∂–µ—Ç–µ –∑–∞–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ –ø–∞—Ä–æ–ª—å."
echo
echo "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è"

read

sudo systemctl daemon-reload
echo "–ó–∞–ø—É—Å–∫ NGINX üöÄ"
sudo systemctl enable nginx
echo "–ó–∞–ø—É—Å–∫ Shadowsocks üöÄ"
sudo systemctl enable shadowsocks-libev

echo "–ó–∞–ø—É—Å–∫ Neutrino üöÄ"
sudo systemctl enable neutrino
sudo systemctl start neutrino

# –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç
exit 0

